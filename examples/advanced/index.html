<html>
  <head>
    <title>A-Frame Height Grid (Terrain) Component - Advanced</title>
    <script src="../build.js"></script>
    <script src="lib/usgsNed.js"></script>
    <!--script src="https://rawgit.com/andreasplesch/aframe-crease-component/master/dist/aframe-crease-component.min.js"></script-->
    <script src="https://raw.githubusercontent.com/andreasplesch/aframe-crease-component/master/dist/aframe-crease-component.min.js"></script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <img id="my-texture" src="../assets/macaca_nigra_self-portrait.jpg">
      </a-assets>
      
      <a-entity light="type: directional; color: #FFF; intensity: 0.9" position="-100 100 100"></a-entity>
      <a-entity light="type: directional; color: #FFF; intensity: 0.9" position="100 100 100"></a-entity>
      <a-entity light="type: directional; color: #FFF; intensity: 0.5" position="0 -100 0"></a-entity>
      <a-entity rotation='0 0 0' position='5 1 13'>
        <a-entity camera look-controls wasd-controls='fly: true' ></a-entity>
      </a-entity>
      <a-entity id='terrain'  heightgrid='xdimension: 2; zdimension: 2; yscale: 0.0002' crease material='src: #my-texture' ></a-entity>  
        
    </a-scene>
  </body>
  <script>
  window.onload = function () {
    var n = 10;
    var lon0 = -119;
    var lat0 = 35;
    var heights = [];
    var el = document.querySelector('#terrain');
    var getElevPs = [];
    el.setAttribute('heightgrid', { xdimension: n, zdimension: n, xspacing: 10/n, zspacing: 10/n, yscale: 0.0002 });
    
    for (var lat = 0; lat < n; lat++) {
      for (var lon = 0; lon < n; lon++) {
        heights.push(0);
        var _tid = window.setTimeout( function (lat, lon) {
          var getElevP = usgsNed.getElevation(lon0+lon/n, lat0-lat/n);
          getElevPs.push(getElevP);
          getElevP.then
              (function(result){
              
              var lon = Math.round((result.x - lon0)*n);
              var lat = Math.round((-result.y + lat0)*n);
              
              heights[lon+n*lat]=result.Elevation;
              el.setAttribute('heightgrid', 'heights', heights);
            },
            function(reason) {
              // rejection
            });
          
          }, 200, lat, lon ); //stagger xhr to server
      }
    }
    Promise.all (getElevPs).then (function(result){console.log("all done " + result);});
  }
  </script>
</html>
